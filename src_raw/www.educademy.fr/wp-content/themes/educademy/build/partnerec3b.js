!function(){"use strict";const t="eduPartnerData",e=90,a=20,r=300,n=function(){};n("Partner tracking initialized");const o={processingUpdate:!1,init(){this.cleanupStorage();const t=this.getUrlParameter("utm_partner");if(t)this.handleUtmPartner(t);else{const t=this.getPartnerData();t&&this.trackPageVisit(t)}},getPartnerData(){try{return JSON.parse(localStorage.getItem(t))||null}catch(t){return null}},getPartnerDataForGTM(){const t=this.getPartnerData();return t&&t.code?{partner_code:t.code,partner_id:t.id,touch_count:t.touchCount||0}:null},updateDataLayer(){if(!window.dataLayer)return;const t=this.getPartnerDataForGTM();t&&(n("Pushing partner data to dataLayer:",t),window.dataLayer.push({partnerData:t}))},saveToStorage:function(e){try{localStorage.setItem(t,JSON.stringify(e)),n("Data saved",e.code),this.updateDataLayer()}catch(t){console.error("Storage error:",t)}},debouncedSave:function(t,e){let a;return function(){const r=this,n=arguments;clearTimeout(a),a=setTimeout((()=>t.apply(r,n)),e)}}((function(t){this.saveToStorage(t)}),r),getUrlParameter(t){const e=new RegExp("[\\?&]"+t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]")+"=([^&#]*)").exec(location.search);return null===e?"":decodeURIComponent(e[1].replace(/\+/g," "))},sanitizeUtmCode(t){return t&&(t=t.toLowerCase().replace(/[^a-z0-9\-_]/g,"")).length>=2&&t.length<=50?t:""},handleUtmPartner(t){this.processingUpdate=!0;const a=this.sanitizeUtmCode(t);a?this.validatePartner(a,((t,r)=>{if(t&&r){const t=this.getPartnerData(),n=Math.floor(Date.now()/1e3),o=n+86400*e,i=location.pathname;if(t&&t.code===a)t.lastTouch=n,t.expiry=Math.max(t.expiry||0,o),t.touchCount=(t.touchCount||0)+1,t.currentPage=i,t.pageVisits||(t.pageVisits={}),t.pageVisits[i]=(t.pageVisits[i]||0)+1,this.saveToStorage(t);else{const t={code:a,id:r.id,firstTouch:n,lastTouch:n,expiry:o,touchCount:1,pageVisits:{[i]:1},currentPage:i};this.saveToStorage(t)}}this.processingUpdate=!1})):this.processingUpdate=!1},validatePartner(t,e){if(!t)return e(!1);const a=new FormData;a.append("action","validate_partner_code"),a.append("utm_partner",t),fetch("/wp-admin/admin-ajax.php",{method:"POST",body:a,credentials:"same-origin"}).then((t=>t.json())).then((t=>e(t.success&&t.data,t.data))).catch((t=>{console.error("Validation error:",t),e(!1)}))},trackPageVisit(t){if(!this.processingUpdate)try{const e=Math.floor(Date.now()/1e3),a=location.pathname;t.lastTouch=e,t.touchCount=(t.touchCount||0)+1,t.currentPage=a,t.pageVisits||(t.pageVisits={}),t.pageVisits[a]=(t.pageVisits[a]||0)+1,this.debouncedSave(t)}catch(t){console.error("Tracking error:",t)}},cleanupStorage(){try{const e=this.getPartnerData();if(!e)return;if(!e.code||!e.expiry||Math.floor(Date.now()/1e3)>e.expiry)return void localStorage.removeItem(t);if(e.pageVisits){let t=!1;Object.keys(e.pageVisits).length>a&&(e.pageVisits=Object.fromEntries(Object.entries(e.pageVisits).sort(((t,e)=>e[1]-t[1])).slice(0,a)),t=!0);for(const[a,r]of Object.entries(e.pageVisits))("number"!=typeof r||isNaN(r)||r<=0)&&(delete e.pageVisits[a],t=!0);t&&this.debouncedSave(e)}}catch(e){localStorage.removeItem(t)}}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>o.init())):o.init(),window.dataLayer&&document.addEventListener("DOMContentLoaded",(()=>{o.updateDataLayer()})),window.PartnerTracker=o,window.getPartnerData=o.getPartnerData.bind(o);const i={init(){this.setupHubSpotIntegration(),this.setupEventListener(),setTimeout(this.updateFormsOnPage,500),setTimeout(this.updateFormsOnPage,2e3)},getPartnerCode(){try{const t=window.PartnerTracker.getPartnerData();return t&&t.code?t.code:null}catch(t){return null}},updatePartnerField(t){const e=this.getPartnerCode();if(e&&t)try{const a=t.querySelector('input[name="partner"]');a&&(a.value=e,n("Form field updated with",e))}catch(t){}},updateFormsOnPage(){document.querySelectorAll("form.hs-form").forEach((t=>i.updatePartnerField(t)));try{document.querySelectorAll("iframe").forEach((t=>{try{t.contentDocument&&t.contentDocument.querySelectorAll("form.hs-form").forEach((t=>i.updatePartnerField(t)))}catch(t){}}))}catch(t){}},setupHubSpotIntegration(){if(window.hbspt&&window.hbspt.forms&&window.hbspt.forms.create){const t=window.hbspt.forms.create;window.hbspt.forms.create=function(e){const a=e.onFormReady||function(){};return e.onFormReady=function(t){a(t),i.updatePartnerField(t)},t(e)}}const t=this.getPartnerCode();t&&(window.hbsptCustomForms=window.hbsptCustomForms||{},window.hbsptCustomForms.onBeforeFormInit=function(e){if(e&&e.fields)for(let a of e.fields)if("partner"===a.name){a.defaultValue=t;break}return e})},setupEventListener(){window.addEventListener("message",(t=>{try{"hsFormCallback"===t.data?.type&&"onFormReady"===t.data?.eventName&&setTimeout(this.updateFormsOnPage,100)}catch(t){}}))}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>i.init())):i.init()}();
//# sourceMappingURL=partner.js.map