name: Miroir vers B (non destructif, sans workflows)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  miroir:
    runs-on: ubuntu-latest
    env:
      TARGET_REPO: Boostactivity/github-link-launch
      TARGET_BRANCH: main
    steps:
      - name: Checkout A (sans cred persistants)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Config Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config --global --unset-all http.https://github.com/.extraheader || true

      - name: Préparer branche miroir locale
        run: |
          # crée/MAJ la branche miroir à partir de HEAD
          if git show-ref --verify --quiet refs/heads/${{ env.TARGET_BRANCH }}; then
            git branch -f ${{ env.TARGET_BRANCH }} HEAD
            git switch ${{ env.TARGET_BRANCH }}
          else
            git switch -c ${{ env.TARGET_BRANCH }} HEAD
          fi

          # ❗️ Exclure les workflows du miroir
          if [ -d ".github/workflows" ]; then
            git rm -r --cached .github/workflows || true
            rm -rf .github/workflows || true
            git commit -m "chore: exclude .github/workflows from mirror" || true
          fi

      - name: Ajouter remote B (avec PAT)
        run: |
          git remote remove target 2>/dev/null || true
          git remote add target "https://x-access-token:${{ secrets.TARGET_TOKEN }}@github.com/${{ env.TARGET_REPO }}.git"
          git remote -v

      - name: Push vers B (MAJ de a-sync uniquement)
        run: |
          git push target ${{ env.TARGET_BRANCH }} --force
