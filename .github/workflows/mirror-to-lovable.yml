name: Mirror A(principal) -> B(main)

on:
  push:
    branches: [ principal ]
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout A (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # IMPORTANT: on n'utilise PAS le GITHUB_TOKEN pour push
          persist-credentials: false

      - name: Git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Debug env & branch
        run: |
          set -x
          echo "Current branch:" && git branch --show-current
          echo "Remotes before:" && git remote -v
          echo "Last commit:" && git --no-pager log -1 --oneline

      - name: Prepare remote to B (Lovable)
        run: |
          set -e
          git remote remove lovable || true
          git remote add lovable https://x-access-token:${{ secrets.MIRROR_TOKEN }}@github.com/Boostactivity/github-link-launch.git
          git remote -v

      - name: Verify auth to B
        run: |
          # Si ça échoue ici => token/permissions/secrets
          git ls-remote lovable

      - name: Push mapping principal -> main (and fallback)
        run: |
          set -e
          # Pousse A/principal -> B/main
          git push -f lovable refs/heads/principal:refs/heads/main
          # (Optionnel) crée aussi B/principal si Lovable attend cette branche
          git push -f lovable refs/heads/principal:refs/heads/principal || true
          # Pousse les tags (facultatif)
          git push -f lovable --tags || true
